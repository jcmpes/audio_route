<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>Ruta de la Se√±al de Audio</title>
    <link
        rel="stylesheet"
        href="./styles.css"
    >
    <link
        rel="stylesheet"
        href="./lens.css"
    >
</head>

<body>
    <h2>Ruta de la Se√±al de Audio</h2>
    <div class="">
        <div style="position: relative; width: 100%;">
            <canvas
                id="sound-source"
                style="width: 100%; height: 400px;"
            ></canvas>
            <img
                id="microphone"
                alt='Micr√≥fono'
                src="./sm58.webp"
                style="position: absolute; width: 200px; height: 190px; cursor: grab; top:0; "
            >
        </div>
    </div>
    <div class='wrapper'>
        <div class="col">
            <div class="row">
                <div class="stage">
                    <div class="stage-header">Salida del Preamplificador</div>
                    <div class="stage-body pre-stage ">
                        <div class='knob-container'>
                            <div class="pre-stage-big-square lens"></div>
                            <div
                                class="knob"
                                id="knob1"
                            ></div>
                        </div>
                        <div
                            class="meter-container"
                            id="pre"
                        >
                            <div class="meter-bar"></div>
                            <div class="peak-indicator"></div>
                        </div>

                    </div>
                </div>
                .
            </div>

            <div class="row">
                <div class="stage">
                    <div class="stage-header">Salida del Canal</div>
                    <div class="stage-body">
                        <div class="slider-container">
                            <div class="ch-fader-big-square lens"></div>
                            <input
                                type="range"
                                class="vertical-slider fader"
                                min="-40"
                                max="22"
                                value="-40"
                                id="gainCanal"
                                oninput="updateMeters()"
                            >
                            <div class='zero-mark'>
                                <span class="zero-value">0</span>
                                <div class='zero-point'>0 ‚Äï</div>
                            </div>
                            <div class="vertical-range-values">
                                <span class="minValue">+10 ‚Äï</span>
                                <span class="maxValue">-‚àû ‚Äï</span>
                            </div>
                        </div>
                        <div
                            class="meter-container"
                            id="canal"
                        >
                            <div class="meter-bar"></div>
                            <div class="peak-indicator"></div>
                        </div>
                    </div>
                </div>

                <div class="stage">
                    <div class="stage-header">Salida de Main Mix</div>
                    <div class="stage-body">
                        <div class="slider-container">
                            <div class="main-fader-big-square lens"></div>
                            <input
                                type="range"
                                class="vertical-slider fader"
                                min="-40"
                                max="22"
                                value="-40"
                                id="gainMix"
                                oninput="updateMeters()"
                            >
                            <div class='zero-mark'>
                                <span class="zero-value">0</span>
                                <div class='zero-point'>0 ‚Äï</div>
                            </div>
                            <div class="vertical-range-values">
                                <span class="minValue">+10 ‚Äï</span>
                                <span class="maxValue">-‚àû ‚Äï</span>
                            </div>
                        </div>
                        <div
                            class="meter-container"
                            id="mix"
                        >
                            <div class="meter-bar"></div>
                            <div class="peak-indicator"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class='row-pc'>
                <div class="stage">
                    <div class="stage-header">Audacity</div>
                    <div class="stage-body-pc">
                        <div class="audacity-big-square lens"></div>
                        <div class="pc-level-control">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                xmlns:xlink="http://www.w3.org/1999/xlink"
                                version="1.0"
                                id="Layer_1"
                                width="20px"
                                height="20px"
                                viewBox="0 0 64 64"
                                enable-background="new 0 0 64 64"
                                xml:space="preserve"
                            >
                                <g>
                                    <path
                                        fill="#231F20"
                                        d="M32,44c6.629,0,12-5.371,12-12V12c0-6.629-5.371-12-12-12S20,5.371,20,12v20C20,38.629,25.371,44,32,44z"
                                    />
                                    <path
                                        fill="#231F20"
                                        d="M52,28c-2.211,0-4,1.789-4,4c0,8.836-7.164,16-16,16s-16-7.164-16-16c0-2.211-1.789-4-4-4s-4,1.789-4,4   c0,11.887,8.656,21.73,20,23.641V60c0,2.211,1.789,4,4,4s4-1.789,4-4v-4.359C47.344,53.73,56,43.887,56,32   C56,29.789,54.211,28,52,28z"
                                    />
                                </g>
                            </svg>
                            <div class="horizontal-slider-container">
                                <div class="horizontal-range-values">
                                    <span class="minValue">-</span>
                                    <span class="maxValue">+</span>
                                </div>
                                <div class="horizontal-range-points">
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                    <span>|</span>
                                </div>
                                <input
                                    type="range"
                                    class="horizontal-slider"
                                    min="-2"
                                    max="40"
                                    value="0"
                                    id="gainDigital"
                                    oninput="updateMeters()"
                                >
                            </div>
                        </div>
                        <div class="stereo-meter-horizontal">
                            <div class='horizontal-ruler'>
                                <div class="horizontal-points">
                                    <div class='horizontal-point'>
                                        <div style='opacity: 0;'>ùÑÖùÑÖ</div>
                                        <div style='opacity: 0;'>-‚àû</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-54</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-48</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-42</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-36</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-30ùÑÖ</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-24</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-18ùÑÖ</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-12ùÑÖ</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>-6</div>
                                    </div>
                                    <div class='horizontal-point'>
                                        <div>ùÑÖùÑÖ</div>
                                        <div>0ùÑÖ</div>
                                    </div>
                                </div>
                            </div>
                            <div class="horizontal-meter-container">
                                <canvas
                                    id="medidor-left"
                                    width="400"
                                    height="14"
                                ></canvas>
                                <div class="horizontal-peak-indicator"></div>
                            </div>
                            <div class="horizontal-meter-container">
                                <canvas
                                    id="medidor-right"
                                    width="400"
                                    height="14"
                                ></canvas>
                                <div class="horizontal-peak-indicator"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col gear">
            <div class="row mixer">
                <div class="line-pre lens"></div>
                <div class="line-ch-fader lens"></div>
                <div class="line-main-fader lens"></div>
                <div class="gear mixer img-container">
                    <img
                        src="./X1622USB.png"
                        alt="Mesa de Mezclas"
                        width='300px'
                    >
                    <div class="pre-stage-small-square lens">
                    </div>
                    <div class="ch-fader-small-square lens">
                    </div>
                    <div class="main-fader-small-square lens">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="audacity-container">
                    <div class="line-audacity lens"></div>
                    <div class="gear">
                        <div class="audacity-small-square lens"></div>
                        <img
                            src="./audacity.png"
                            alt="audacity"
                            width='400px'
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        let micLevel = 0;
        let initialLevel = 3;
        function logScale (value, minDB, maxDB) {
            let normalized = (value + 20) / 40; // Normaliza entre 0 y 1
            let logFactor = Math.log10(9 * normalized + 1); // Ajusta la curva logar√≠tmica
            return minDB + (maxDB - minDB) * logFactor;
        }

        function updateStereoMeter (value) {
            value = Math.min(Math.max(value, 0), 100);

            const drawMeter = (meterContainer, value) => {
                const canvas = meterContainer.querySelector('canvas');
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                const peakIndicator = meterContainer.querySelector('.horizontal-peak-indicator');

                // Limpia el canvas
                ctx.clearRect(0, 0, width, height);

                // Crea el gradiente
                const gradient = ctx.createLinearGradient(0, 0, width, 0);

                if (value <= 80) {
                    // Solo verde hasta el 80%
                    gradient.addColorStop(0, '#75D770');
                    gradient.addColorStop(1, '#75D770');
                } else if (value <= 90) {
                    // Degradado verde a amarillo en el noveno segmento
                    const greenStop = 80 / 100;
                    const yellowStop = 92 / 100;
                    const valuePercentage = value / 100;

                    gradient.addColorStop(0, '#75D770');
                    gradient.addColorStop(greenStop, '#75D770');
                    gradient.addColorStop(valuePercentage, '#F9F605');
                    gradient.addColorStop(yellowStop, '#F9F605');
                } else {
                    // Degradado amarillo a rojo en el d√©cimo segmento
                    const greenStop = 80 / 100;
                    const yellowStop = 92 / 100;
                    const redStop = 1;
                    const valuePercentage = (value - 90) / 10; // Ajuste aqu√≠

                    gradient.addColorStop(0, '#75D770');
                    gradient.addColorStop(greenStop, '#75D770');
                    gradient.addColorStop(yellowStop, '#F9F605');
                    gradient.addColorStop(yellowStop + valuePercentage * (redStop - yellowStop), '#FF2D0A'); // Ajuste aqu√≠
                    gradient.addColorStop(redStop, '#FF2D0A');
                }

                // Dibuja el gradiente
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width * (value / 100), height);

                // Indicador de pico
                if (value > 96) {
                    peakIndicator.classList.add('active');
                } else {
                    setTimeout(() => {
                        peakIndicator.classList.remove('active');
                    }, 500);
                }
            };

            drawMeter(document.querySelector('#medidor-left').parentNode, value);
            drawMeter(document.querySelector('#medidor-right').parentNode, value);
        }


        function updateMeters () {
            let gainPre = parseInt(document.getElementById('knob1').textContent);
            if (!gainPre) {
                gainPre = 10;
            }
            if (gainPre > 55) {
                gainPre = gainPre * 1.3;
            }
            let gainCanal = logScale(parseInt(document.getElementById('gainCanal').value), -60, 10);
            let gainMix = logScale(parseInt(document.getElementById('gainMix').value), -60, 10);
            let gainDigital = parseInt(document.getElementById('gainDigital').value);
            if (gainDigital < 0) {
                gainDigital = gainDigital * 33
            }
            let preLevel = Math.min(100, Math.max(5, Math.min(gainPre + 3 * micLevel, micLevel * gainPre)));
            console.log(micLevel)
            let canalLevel = Math.min(100, Math.max(gainPre, preLevel + gainCanal));
            let mixLevel = Math.min(100, Math.max(5, canalLevel + gainMix));

            let levels = { pre: preLevel, canal: canalLevel, mix: mixLevel };

            Object.keys(levels).forEach(id => {
                let meterBar = document.getElementById(id).querySelector('.meter-bar');
                let peakIndicator = document.getElementById(id).querySelector('.peak-indicator');
                meterBar.style.height = levels[id] + '%';

                if (levels[id] > 96) {
                    peakIndicator.style.opacity = 1;
                } else {
                    setTimeout(() => {
                        peakIndicator.style.opacity = 0
                    }, 500)
                }
            });
            let digitalLevel = Math.min(100, Math.max(5, mixLevel + gainDigital));
            if (!digitalLevel) {
                digitalLevel = 5
            }
            updateStereoMeter(digitalLevel)
        }

        updateMeters();

        function getRandomAmplitude (time) {
            const base = Math.sin(time * 0.05) * 0.3 + 0.7;  // Oscilaci√≥n lenta
            const pulse = Math.random() * 0.5 + 0.5;        // Variabilidad r√°pida
            const silence = Math.random() > 0.5 ? 0 : 1; // Simula pausas entre palabras
            const result = base * pulse * silence;
            return result
        }

        function updateLevel () {
            const time = Date.now();
            const voiceVariation = getRandomAmplitude(time);
            const canvasRect = canvas.getBoundingClientRect();
            const micRect = microphone.getBoundingClientRect();
            const micX = canvasRect.left - micRect.left;

            let dynamicLevel = initialLevel * voiceVariation
            micLevel = dynamicLevel * calculateAttenuationFactor(micX)
            updateMeters()
        }

        setInterval(updateLevel, 100);
    </script>
    <script
        type="text/javascript"
        src="./knob.js"
    ></script>
    <script>
        let dial1 = new Knob({
            size: "large",
            type: "Hexagonal",
            lowVal: 10,
            highVal: 60,
            value: 10,
            sensitivity: 3,
            lblTxtColor: "black",
            id: "knob1",
        });
        dial1.getValue()
        function knobChanged (id, val) {
            updateMeters();
        }
    </script>
    <script>
        const canvas = document.getElementById('sound-source');
        const ctx = canvas.getContext('2d');
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        const microphone = document.getElementById('microphone');
        const levelMeter = document.getElementById('level-meter');

        const sourceX = 0;
        const sourceY = 70;
        let radius = 30;
        let opacity = 1;

        let isDragging = false;
        let offsetX, offsetY;

        microphone.addEventListener('mousedown', (e) => {
            isDragging = true;
            const rect = microphone.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top + 60;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const newLeft = e.clientX - offsetX;
            const newTop = e.clientY - offsetY;

            const canvasRect = canvas.getBoundingClientRect();
            const micRect = microphone.getBoundingClientRect();

            const minLeft = canvasRect.left;
            const maxLeft = canvasRect.right - micRect.width;
            const minTop = canvasRect.top;
            const maxTop = canvasRect.bottom - micRect.height;

            microphone.style.left = `${Math.min(Math.max(newLeft, minLeft), maxLeft)}px`;
            microphone.style.top = `${Math.min(Math.max(newTop, minTop), maxTop)}px`;

            // Calcula y actualiza el nivel en tiempo real
            updateLevel();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });



        function animate () {
            ctx.clearRect(0, 0, width, height);

            for (let i = 0; i < 3; i++) {
                const currentRadius = radius - i * 20;
                if (currentRadius > 0) {
                    ctx.beginPath();
                    ctx.arc(sourceX, sourceY, currentRadius, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(0, 0, 0, ${opacity - i * 0.2})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            radius += 3;
            opacity -= 0.02;

            if (opacity < 0) {
                radius = 30;
                opacity = 1;
            }

            requestAnimationFrame(animate);
        }

        function calculateAttenuationFactor (micX) {
            const canvas = document.getElementById('sound-source');
            const canvasWidth = canvas.offsetWidth;

            // Distancia m√°xima desde la fuente de sonido (izquierda del canvas)
            const maxDistance = canvasWidth;

            // Distancia del micr√≥fono a la fuente de sonido
            const distance = Math.abs(micX);

            // Distancia m√≠nima para evitar divisiones por cero o valores infinitos
            const minDistance = 30;

            // Asegurar que la distancia sea al menos 1
            const effectiveDistance = Math.max(distance, minDistance);

            // Calcular el factor de atenuaci√≥n basado en la distancia
            const attenuationFactor = maxDistance / effectiveDistance;

            // Ajustar el factor de atenuaci√≥n para simular la atenuaci√≥n cuadr√°tica
            const adjustedFactor = Math.pow(attenuationFactor, 2);


            // Convertir el factor de atenuaci√≥n a decibelios (dB)
            const attenuationDB = 10 * Math.log10(adjustedFactor);

            // Mapear el factor de atenuaci√≥n a un rango de 0 a 1
            const mappedFactor = Math.max(0, 1 + attenuationDB / 6); // Ajuste aqu√≠

            return mappedFactor;
        }

        animate();
    </script>
</body>

</html>